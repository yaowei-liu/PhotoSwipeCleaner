name: CI/CD

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  test:
    name: Build and Test
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure XcodeGen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi
          xcodegen --version

      - name: Generate project
        run: xcodegen generate

      - name: Pick simulator
        id: simulator
        run: |
          SIMULATOR_ID=$(xcrun simctl list devices available | grep -E "iPhone 16|iPhone 15|iPhone 14" | head -1 | grep -oE '[A-F0-9-]{36}')
          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[A-F0-9-]{36}')
          fi
          if [ -z "$SIMULATOR_ID" ]; then
            echo "No iPhone simulator found" >&2
            exit 1
          fi
          echo "id=$SIMULATOR_ID" >> "$GITHUB_OUTPUT"

      - name: Run tests
        run: |
          xcodebuild \
            -project PhotoSwipeCleaner.xcodeproj \
            -scheme PhotoSwipeCleaner \
            -destination "platform=iOS Simulator,id=${{ steps.simulator.outputs.id }}" \
            -configuration Debug \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 7

  release-archive:
    name: Build Release Archive
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure XcodeGen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Generate project
        run: xcodegen generate

      - name: Archive app
        run: |
          xcodebuild \
            -project PhotoSwipeCleaner.xcodeproj \
            -scheme PhotoSwipeCleaner \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "$PWD/build/PhotoSwipeCleaner.xcarchive" \
            CODE_SIGNING_ALLOWED=NO \
            archive

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: build/PhotoSwipeCleaner.xcarchive
          retention-days: 14
