name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check XcodeGen installation
        id: xcodegen
        run: |
          if ! command -v xcodegen &> /dev/null; then
            echo "XcodeGen not found, installing..."
            echo "installed=false" >> $GITHUB_OUTPUT
          else
            echo "XcodeGen found: $(xcodegen --version)"
            echo "installed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Install XcodeGen
        if: steps.xcodegen.outputs.installed == 'false'
        run: brew install xcodegen
        
      - name: Generate Xcode project
        run: |
          xcodegen generate
          echo "Project generated successfully"
          
      - name: List available simulators
        run: |
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -10
          
      - name: Get iPhone simulator
        id: simulator
        run: |
          SIMULATOR=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*(\([^)]*\)).*/\1/' | head -1)
          echo "SIMULATOR_ID=$SIMULATOR" >> $GITHUB_OUTPUT
          
      - name: Build for iOS Simulator
        id: build
        run: |
          xcodebuild -project PhotoSwipeCleaner.xcodeproj \
            -scheme PhotoSwipeCleaner \
            -destination "platform=iOS Simulator,id=${{ steps.simulator.outputs.SIMULATOR_ID }}" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build 2>&1 | tail -50
          
      - name: Check build result
        if: ${{ always() }}
        run: |
          if [ -f "build/BUILD.md" ]; then
            echo "Build completed"
          fi
          
      - name: Upload build artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ~/Library/Developer/Xcode/DerivedData/PhotoSwipeCleaner-*/Logs
          retention-days: 5
          
  test:
    name: Run Tests
    needs: build
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Generate Xcode project
        run: xcodegen generate
        
      - name: Get iPhone simulator
        id: simulator
        run: |
          SIMULATOR=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*(\([^)]*\)).*/\1/' | head -1)
          echo "SIMULATOR_ID=$SIMULATOR" >> $GITHUB_OUTPUT
          
      - name: Run tests
        run: |
          echo "No tests configured yet"
          echo "Tests would run here"
          
      - name: Test summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- No tests configured" >> $GITHUB_STEP_SUMMARY
          echo "- Add test files to enable testing" >> $GITHUB_STEP_SUMMARY
